"use strict";angular.module("starter.directives",[]).directive("LoadingContainer",function(){return{restrict:"A",scope:false,link:function(scope,element,attrs){var loadingLayer=angular.element('<span class="loaderspinner72">loading...</span>');element.append(loadingLayer);element.addClass("loading-container");scope.$watch(attrs.loadingContainer,function(value){loadingLayer.toggleClass("ng-hide",!value)})}}});"use strict";angular.module("starter.jquery-extras",[]).run(function(){angular.element(document).ready(function(){var form=document.getElementById("adminForm"),$form=jQuery(form);$form.find(".post-attrs-group a").click(function(e){var btn=jQuery(e.target),v,btnParent;v=btn.attr("data-value");if(typeof v==="undefined"){btnParent=btn.parents(".xt-button");v=btnParent.attr("data-value")}$form.find(".xt-subform").hide();$form.find(".xt-subform-"+v).show()});$form.find(".xt-subform").css("display","none")})});"use strict";angular.module("starter.requests-service",["extlycore","ngResource"]).factory("Requests",["SefHelper","$resource",function(SefHelper,$resource){var url=SefHelper.route("index.php?option=com_autotweet&view=requests&format=json");var xTtoken=jQuery("#XTtoken").attr("name");var jsonParse=function(data){var body=data.split(/@EXTLYSTART@|@EXTLYEND@/);if(body.length===3){var packet=CryptoJS.enc.Base64.parse(body[1]);var utf8=CryptoJS.enc.Utf8.stringify(packet);return JSON.parse(utf8)}else{return{status:false,message:data}}};return $resource(url,{},{query:{method:"POST",params:{task:"@taskCommand",_token:xTtoken},isArray:true,transformResponse:function(data,headersGetter){return jsonParse(data)}},save:{method:"POST",params:{task:"@taskCommand",_token:xTtoken,ref_id:"@ref_id"},transformResponse:function(data,headersGetter){return jsonParse(data)}},get:{method:"POST",params:{task:"@taskCommand",_token:xTtoken,id:"@request_id"},transformResponse:function(data,headersGetter){return jsonParse(data)}}})}]);"use strict";angular.module("starter.agenda-service",[]).factory("Agenda",function(){var STORAGE_ID="agendas-autotweet",_this=this;_this.get=function(){return JSON.parse(localStorage.getItem(STORAGE_ID)||"[]")};_this.put=function(todos){localStorage.setItem(STORAGE_ID,JSON.stringify(todos))};_this.clear=function(){this.put([])};return{get:_this.get,put:_this.put,clear:_this.clear}});"use strict";angular.module("starter.request-helper",[]).factory("RequestHelper",[function(){var _this=this;_this.formatDatesTimes=function(agendas){var dates=[];_.each(agendas,function(agenda){dates.push(agenda.agendaDate+" "+agenda.agendaTime)});return dates};_this.hasPastDates=function(agendas){var today=new Date,isPastDate=false;if(!agendas||agendas.length===0){return false}try{_.each(agendas,function(dayTime){var d,dateString=dayTime;if(dayTime.match(/^\d\d\d\d-\d\d-\d\d \d?\d:\d\d$/)){dateString=dayTime.replace(" ","T")+":00"}if(dayTime.match(/^\d\d\d\d-\d\d-\d\d \d?\d:\d\d:\d\d$/)){dateString=dayTime.replace(" ","T")}d=new Date(dateString);if(d.getTime()<today.getTime()){isPastDate=true}})}catch(e){isPastDate=true}return isPastDate};_this.getChannels=function(channels){if(_.isNumber(channels)&&channels>0){return[channels]}if(_.isString(channels)&&parseInt(channels)>0){return[channels]}if(_.isArray(channels)){return channels}return[]};_this.getChannelsText=function(channels){var options,channelsText;if(!window.channelchooser){return""}options=angular.element(window.channelchooser).find("option");options=_.filter(options,function(option){return option.selected&&parseInt(option.value)>0});channelsText=_.reduce(options,function(memo,option){var e=angular.element(option),txt=e.text();if(_.isEmpty(memo)){return txt}else{return memo+", "+txt}},"");return channelsText};_this.isValidAgendaRepeat=function(agendas,unixMhdmd){var invalid=unixMhdmd&&unixMhdmd.length>0&&agendas.length>1;return!invalid};_this.generateRequestHash=function(){var now=new Date,hash;hash=CryptoJS.MD5(""+now.getTime()+_.random(0,9007199254740992));hash=CryptoJS.MD5(hash+_.random(0,9007199254740992));hash=CryptoJS.MD5(hash+_.random(0,9007199254740992));return hash.toString(CryptoJS.enc.Hex)};_this.isValidCronjobExpr=function(expr){var testExpr=/^(((([0-9]+)(\,[0-9]+)*)|\*) ){4}((([0-9]+)(\,[0-9]+)*)|\*)$/;return _.isEmpty(expr)||testExpr.test(expr)};return{formatDatesTimes:_this.formatDatesTimes,hasPastDates:_this.hasPastDates,getChannelsText:_this.getChannelsText,isValidAgendaRepeat:_this.isValidAgendaRepeat,generateRequestHash:_this.generateRequestHash,getChannels:_this.getChannels,isValidCronjobExpr:_this.isValidCronjobExpr}}]);"use strict";angular.module("starter.editor-controller",["starter.requests-service","starter.agenda-service","starter.request-helper","ui.bootstrap.buttons"]).controller("EditorController",function($scope,$rootScope,$sce,Requests,Agenda,RequestHelper){var _this=this;var local=$scope.editorCtrl;local.waiting=false;local.showDialog=false;_this.saveAndLoad=false;local.addRequest=function(e){var descr,request,params={},attrs={},agendas=[],unixMhdmdValue;e.preventDefault();local.showDialog=false;if(local.waiting){_this.error({messageType:"error",message:"Please, try to save it again."});return}descr=angular.element(window.description).val();if(!window.description&&_.isUndefined(descr)){descr=angular.element(document.getElementById("description")).val()}descr=descr.trim();if(descr.length===0){_this.error({messageType:"error",message:"Empty message. Please, fill the main text field."});return}agendas=Agenda.get();agendas=RequestHelper.formatDatesTimes(agendas);if(RequestHelper.hasPastDates(agendas)){_this.error({messageType:"error",message:"Agenda has dates in the past. Please, remove them."});return false}unixMhdmdValue=null;if(window.unix_mhdmd){unixMhdmdValue=angular.element(window.unix_mhdmd).val();if(!RequestHelper.isValidCronjobExpr(unixMhdmdValue)){_this.error({messageType:"error",message:"Repeat Expression is invalid."});return false}if(!RequestHelper.isValidAgendaRepeat(agendas,unixMhdmdValue)){_this.error({messageType:"error",message:"Repeat Expression not allowed for more than one Agenda date."});return false}}params.plugin=local.plugin;params.description=descr;params.url=local.url_value;local.image_url_value=angular.element(window.image_url).val();params.image_url=local.image_url_value;if(window.hashtags){params.hashtags=angular.element(window.hashtags).val()}else{params.hashtags=""}attrs.ref_id=local.ref_id;attrs.fulltext=local.fulltext_value;if(window.itemeditor_postthis){attrs.postthis=angular.element(window.itemeditor_postthis).val()}else{attrs.postthis=null}if(window.itemeditor_evergreen){attrs.evergreen=angular.element(window.itemeditor_evergreen).val()}else{attrs.evergreen=null}attrs.unix_mhdmd=unixMhdmdValue;attrs.repeat_until=local.repeat_until_value;attrs.channels=local.channelchooser_value;attrs.channels_text=RequestHelper.getChannelsText(local.channelchooser_value);attrs.agenda=agendas;attrs.image="";if(local.option_filter){attrs.option_filter=local.option_filter}if(local.plugin=="autotweetpost"){params.taskCommand="applyAjaxOwnAction"}else{params.taskCommand="applyAjaxPluginAction"}params.option=local.option;params.view=local.view;params.task=local.task;params.returnurl=local.returnurl;params[angular.element(window.XTtoken).attr("name")]=1;params.lang=angular.element(window.XTlang).val();params.published=local.published;params.ajax=1;params.ref_id=local.ref_id;params.id=local.request_id;params.autotweet_advanced_attrs=JSON.stringify(attrs);local.waiting=true;request=new Requests(params);request.$save(null,_this.success,_this.error)};_this.success=function(response){local.showDialog=true;local.messageResult=response.status;local.messageText=$sce.trustAsHtml(response.message);local.request_id=0;local.ref_id=response.hash;local.waiting=false;if(response.status&&_this.redirectOnSuccess){if(Joomla.submitform){return Joomla.submitform("cancel")}return Joomla.submitbutton("cancel")}_this.redirectOnSuccess=false;if(_this.saveAndLoad){$rootScope.$emit("editRequest",response.request_id);_this.saveAndLoad=false}else{_this.reset()}$rootScope.$emit("newRequest")};_this.error=function(response){local.showDialog=true;local.messageResult=false;local.messageText=$sce.trustAsHtml("Error: "+response.message);_this.redirectOnSuccess=false;local.waiting=false;$scope.$digest()};_this.callbackAddRequest=function(event){_this.saveAndLoad=false;_this.addRequest(event)};_this.callbackAddRequestLoad=function(event){_this.saveAndLoad=true;_this.addRequest(event)};_this.callbackAddRequestAndRedirect=function(event){_this.redirectOnSuccess=true;_this.callbackAddRequestLoad(event)};local.menuitemlistHide=function(){var el=document.getElementById("menulist_group"),menuitemlist=angular.element(el);if(menuitemlist.hasClass("hide")){menuitemlist.removeClass("hide")}else{menuitemlist.addClass("hide")}};_this.load=function(request){_this.reset();local.waiting=false;local.messageResult="success";local.messageText=$sce.trustAsHtml("-Loaded-");local.request_id=request.id;local.ref_id=request.ref_id;local.plugin=request.plugin;$rootScope.$emit("updateMessageView",request.description,request.xtform.hashtags);local.url_value=request.url;local.image_url_value=request.image_url;setTimeout(function(){window.xtRefreshPreview("","image_url")},1);if(request.autotweet_advanced_attrs){local.fulltext_value=request.autotweet_advanced_attrs.fulltext;local.option_filter=request.autotweet_advanced_attrs.option;$rootScope.$emit("loadAgenda",request.autotweet_advanced_attrs.agenda);setTimeout(function(){angular.element(document.getElementById("ctrl_itemeditor_postthis_"+request.autotweet_advanced_attrs.postthis)).click();angular.element(document.getElementById("ctrl_itemeditor_evergreen_"+request.autotweet_advanced_attrs.evergreen)).click()},1);local.channelchooser_value=request.autotweet_advanced_attrs.channels;angular.element(window.unix_mhdmd).val(request.autotweet_advanced_attrs.unix_mhdmd);local.repeat_until_value=request.autotweet_advanced_attrs.repeat_until}};_this.getHash=function(){return RequestHelper.generateRequestHash()};_this.reset=function(){local.showDialog=false;local.request_id=0;local.ref_id=_this.getHash();local.plugin="autotweetpost";$rootScope.$emit("updateMessageView","","");local.url_value="";local.menuitem_value="";local.fulltext_value="";local.image_url_value="";window.xtRefreshPreview("","image_url");angular.element(document.getElementById("image_url-image")).html("");setTimeout(function(){angular.element(document.getElementById("ctrl_itemeditor_postthis_1")).click();angular.element(document.getElementById("ctrl_itemeditor_evergreen_2")).click()},1);local.channelchooser_value=[];if(window.unix_mhdmd){angular.element(window.unix_mhdmd).val("")}local.repeat_until_value="";$rootScope.$emit("loadAgenda",[]);if(window.unix_mhdmd_minute){angular.element(window.unix_mhdmd_minute).val("*");angular.element(window.unix_mhdmd_hour).val("*");angular.element(window.unix_mhdmd_day).val("*");angular.element(window.unix_mhdmd_month).val("*");angular.element(window.unix_mhdmd_weekday).val("*")}};_this.editRequest=function(e,requestId){var request,params={};e.preventDefault();local.showDialog=false;if(local.waiting){_this.error({messageType:"error",message:"Please, try to save it again."});return}if(!requestId){return}params.id=requestId;params.request_id=requestId;params.taskCommand="readAjaxAction";params.ajax=1;local.waiting=true;request=new Requests(params);request.$get(null,_this.load,_this.error)};_this.publishRequest=function(e,requestId){var request,params={};e.preventDefault();local.showDialog=false;if(local.waiting){_this.error({messageType:"error",message:"Please, try to publish it again."});return}if(!requestId){return}params.id=requestId;params.request_id=requestId;params.taskCommand="publishAjaxAction";params.ajax=1;local.waiting=true;request=new Requests(params);request.$save(null,_this.success,_this.error)};_this.cancelRequest=function(e,requestId){var request,params={};e.preventDefault();local.showDialog=false;if(local.waiting){_this.error({messageType:"error",message:"Please, try to cancel it again."});return}if(!requestId){return}params.id=requestId;params.request_id=requestId;params.taskCommand="cancelAjaxAction";params.ajax=1;local.waiting=true;request=new Requests(params);request.$save(null,_this.success,_this.error)};_this.loadUrl=function(itemId){var request,params={};local.showDialog=false;if(local.waiting){_this.error({messageType:"error",message:"Unable to load Urls, Please, try it again."});return}params.itemId=itemId;params.taskCommand="routeAjaxItemId";params.ajax=1;local.waiting=true;request=new Requests(params);request.$save(null,_this.successRoute,_this.error)};_this.successRoute=function(response){local.url_value=response.url;local.waiting=false};_this.resetToolbarButtonListener=function(id){var toolbarSaveNewDiv=document.getElementById(id);if(!toolbarSaveNewDiv){return}var buttonInsideDiv=toolbarSaveNewDiv.querySelector("button");if(!buttonInsideDiv){return}var clonedButton=buttonInsideDiv.cloneNode(true);buttonInsideDiv.parentNode.replaceChild(clonedButton,buttonInsideDiv)};_this.reset();$rootScope.$on("editRequest",_this.editRequest);$rootScope.$on("publishRequest",_this.publishRequest);$rootScope.$on("cancelRequest",_this.cancelRequest);_this.resetToolbarButtonListener("toolbar-apply");var holder=document.getElementById("toolbar-apply"),buttons;if(holder){angular.element(holder).find("button").attr("onclick",null).click(_this.callbackAddRequestLoad)}_this.resetToolbarButtonListener("toolbar-save");holder=document.getElementById("toolbar-save");if(holder){angular.element(holder).find("button").attr("onclick",null).click(_this.callbackAddRequestAndRedirect)}_this.resetToolbarButtonListener("toolbar-save-new");holder=document.getElementById("toolbar-save-new");if(holder){angular.element(holder).find("button").attr("onclick",null).click(_this.callbackAddRequest)}holder=document.getElementById("XTF0FHeaderHolder");buttons=angular.element(holder).find("button");_.each(buttons,function(button,i){if(i===0){angular.element(button).attr("onclick",null).click(_this.callbackAddRequestLoad)}if(i===1){angular.element(button).attr("onclick",null).click(_this.callbackAddRequestAndRedirect)}if(i===2){angular.element(button).attr("onclick",null).click(_this.callbackAddRequest)}})});"use strict";angular.module("starter.requests-controller",["starter.requests-service","ngTable"]).controller("RequestsController",function($scope,$timeout,$rootScope,Requests,ngTableParams){var _this=this,local=$scope.requestsCtrl,element=document.getElementById("list_limit"),listLimit=angular.element(element).val();local.firstTime=true;local.requestsTable=new ngTableParams({count:listLimit},{total:0,counts:[],getData:function($defer,params){local.waiting=true;Requests.query({taskCommand:"browse",ajax:1,boxchecked:0,hidemainmenu:0,filter_order:"publish_up",filter_order_Dir:"ASC",limitstart:0,limit:listLimit,publish_up:0,search:"",plugin:0,published:0},function(data){$timeout(function(){local.waiting=false;$defer.resolve(data);if(local.firstTime){local.firstTime=false;_this.loadReqParam(data)}},500)})}});_this.loadReqParam=function(data){var reqId=_this.getQueryParams("req-id");if(!reqId){return false}data.$promise.then(function(data){var i=0;$rootScope.$emit("editRequest",reqId);_.each(data,function(item){if(item.id==reqId){data[i].$selected=true}i++})})};_this.getQueryParams=function(queryString){var query=window.location.search.substring(1);var obj=_.chain(query.split("&")).map(function(params){var p=params.split("=");return[p[0],decodeURIComponent(p[1])]}).object().value();return obj[queryString]};local.requestsTable.doRefresh=function(){local.requestsTable.reload()};local.requestsTable.selectRow=function(row){for(var i=0;i<local.requestsTable.data.length;i++){local.requestsTable.data[i].$selected=false}row.$selected=true};local.requestsTable.editRow=function(row){$rootScope.$emit("editRequest",row.id)};local.requestsTable.publishRow=function(row){$rootScope.$emit("publishRequest",row.id)};local.requestsTable.cancelRow=function(row){$rootScope.$emit("cancelRequest",row.id)};$rootScope.$on("newRequest",local.requestsTable.doRefresh)});"use strict";angular.module("starter.agenda-controller",["starter.agenda-service"]).controller("AgendaController",function($scope,$rootScope,Agenda){var agendaCtrl=$scope.agendaCtrl,agendas=agendaCtrl.agendas=Agenda.get();Agenda.clear();agendaCtrl.add=function(){var schedulingDate=agendaCtrl.scheduling_date_value;var schedulingTime=agendaCtrl.scheduling_time_value;if(!schedulingDate||!schedulingTime){return}schedulingDate=schedulingDate.trim();if(!schedulingDate.length){return}agendas.push({agendaDate:schedulingDate,agendaTime:schedulingTime});Agenda.put(agendas);agendaCtrl.scheduling_date_value=""};agendaCtrl.remove=function(agenda){agendas.splice(agendas.indexOf(agenda),1);Agenda.put(agendas)};$rootScope.$on("newRequest",function(){Agenda.clear();agendas=agendaCtrl.agendas=Agenda.get()});$rootScope.$on("loadDate",function(event,schedulingDate){agendaCtrl.scheduling_date_value=schedulingDate});$rootScope.$on("loadTime",function(event,schedulingTime){agendaCtrl.scheduling_time_value=schedulingTime});$rootScope.$on("loadAgenda",function(event,param){var output=[];_.each(param,function(item){var schedulingDate,schedulingTime,parts=item.split(" ");schedulingDate=parts[0];schedulingTime=parts[1];parts=schedulingTime.split(":");if(parts.length==3){parts.splice(2,1);schedulingTime=parts.join(":")}output.push({agendaDate:schedulingDate,agendaTime:schedulingTime})});Agenda.put(output);agendas=agendaCtrl.agendas=Agenda.get();agendaCtrl.scheduling_date_value=""})});"use strict";angular.module("starter.cronjob-expr-controller",[]).controller("CronjobExprController",function($scope){var local=$scope.cronjobExprCtlr,_this=this;local.update=function(){var mhdmd=local.minute_value+" "+local.hour_value+" "+local.day_value+" "+local.month_value+" "+local.weekday_value;local.unix_mhdmd_value=mhdmd};_this.resetControls=function(){local.minute_value="*";local.hour_value="*";local.day_value="*";local.month_value="*";local.weekday_value="*"};local.reset=function(){_this.resetControls();local.unix_mhdmd_value=""};local.example1=function(){_this.resetControls();local.minute_value="30";local.hour_value="9";local.update()};local.example2=function(){_this.resetControls();local.minute_value="30";local.hour_value="9";local.weekday_value="1";local.update()};local.example3=function(){_this.resetControls();local.minute_value="15";local.hour_value="0,6,12,18";local.update()};local.example4=function(){_this.resetControls();local.minute_value="59";local.unix_mhdmd_value="59 11 * * 1,3,5"};local.example5=function(){_this.resetControls();local.minute_value="47";local.hour_value="6";local.day_value="8";local.month_value="12";local.update()}});"use strict";angular.module("starter.message-controller",[]).controller("MessageController",function($scope,$rootScope){var _this=this||{};var local=$scope.messageCtrl;local.remainingCount=0;local.remainingCountClass="";local.countRemaining=function(){var style,c,h;c=local.description_value?local.description_value.length:0;h=_.isEmpty(_this.hashtags_value)?0:_this.hashtags_value.length+1;c=c+h;style="label";if(c>0&&c<=60){style="xt-label xt-label-success"}else if(c>60&&c<=100){style="xt-label xt-label-warning"}else if(c>100){style="xt-label xt-label-error"}local.remainingCount=c;local.remainingCountClass=style};_this.updateMessageView=function(e,desc,hash){local.description_value=desc;if(window.hashtags){local.hashtags_value=hash}local.countRemaining()};$rootScope.$on("updateMessageView",_this.updateMessageView)});"use strict";(function(){var deps=["starter.message-controller","starter.editor-controller","starter.requests-controller","starter.agenda-controller","starter.cronjob-expr-controller","starter.jquery-extras"];angular.module("starter",deps).config(function($logProvider,$compileProvider){$logProvider.debugEnabled(false);$compileProvider.debugInfoEnabled(false)})})();
