EasyBlog.module("site/polls",function(u){EasyBlog.Controller("Polls",{defaultOptions:{"{error}":"[data-poll-error]","{closeErrorButton}":"[data-poll-error] [data-fd-dismiss=alert]","{input}":"[data-poll-input]","{option}":"[data-poll-option]","{votedItem}":"[data-poll-input].is-voted","{items}":"[data-poll-item-wrapper]","{count}":"[data-poll-count]"}},function(c){return{init:function(){},isVoting:!1,showError:function(t,a){a=a.find("[data-poll-error]"),a.find("[data-alert-wrapper]");a.find("[data-fd-alert-message]").html(t),a.removeClass("t-hidden")},hideError:function(t){t=t.find("[data-poll-error]");t.find("[data-fd-alert-message]").html(""),t.addClass("t-hidden")},"{closeErrorButton} click":function(t,a){a.preventDefault(),a.stopPropagation(),t.closest("[data-poll-error]").addClass("t-hidden")},"{count} click":function(t,a){var o=t.closest("[data-poll-wrapper]"),t=t.closest("[data-poll-item-wrapper]"),i=o.data("id"),l=t.data("id");EasyBlog.dialog({content:EasyBlog.ajax("site/views/polls/showVoters",{pollId:i,itemId:l}),bindings:{"{loadMore} click":function(o,t){o=u(o);var e=this,a=o.data("nextlimit");o.enabled()&&(o.disabled(!0),o.addClass("is-loading"),EasyBlog.ajax("site/views/polls/loadVoters",{pollId:i,itemId:l,start:a}).done(function(t,a){e.voterList().append(t),o.enabled(!0),0<a?(o.data("nextlimit",a),o.removeClass("is-loading")):o.hide()}))}}})},action:function(t,a){var o=(t=!(t.is(":checkbox")||t.is(":radio"))?t.closest("[data-poll-item-wrapper]").find("input"):t).closest("[data-poll-wrapper]"),e=o.data("multiple"),i=t.hasClass("is-voted"),l=o.data("unvote"),d="vote",n=!0,s=o.data("id"),r=t.closest("[data-poll-item-wrapper]").data("id"),p=u('[data-poll-item-wrapper][data-id="'+r+'"]').find("[data-poll-input]");c.updateCheckbox(p,!i),i&&l&&(n=!(d="unvote")),!c.options.userId||c.isVoting||i&&!l?a.preventDefault():(c.hideError(o),c.isVoting=!0,"unvote"==d&&c.updateCheckbox(p,n),a=c.votedItem(),"vote"==d&&0<a.length&&!e&&c.input().removeClass("is-voted"),EasyBlog.ajax("site/views/polls/action",{pollId:s,itemId:r,actionType:d}).done(function(t){c.isVoting=!1,c.updatePoll(d,r,t)}).fail(function(t){c.showError(t,o),c.isVoting=!1;t=!n;c.updateCheckbox(p,t),e||c.updateCheckbox(o.find("[data-poll-item-wrapper]").find("[data-poll-input].is-voted"),!0)}))},"{option} click":function(t,a){c.action(t,a)},"{input} click":function(t,a){c.action(t,a)},updateCheckbox:function(t,a){t.prop("checked",a)},updatePoll:function(l,d,t){var a=u('[data-poll-wrapper][data-id="'+t.id+'"]'),n=parseInt(t.totalVotes);d=parseInt(d),t.items.forEach(function(t,a){var o,e=u('[data-poll-item-wrapper][data-id="'+t.id+'"]'),i=parseInt(t.count)/n*100;parseInt(t.id)===d&&(o=e.find("[data-poll-input]"),"vote"==l&&o.addClass("is-voted"),"unvote"==l&&o.removeClass("is-voted")),0===n&&(i=0),e.find("[data-poll-count]").html(t.votesText),e.find("[data-progress-bar]").css("width",i+"%")}),a.find("[data-poll-total-votes]").html(t.totalVotesText)}}}),this.resolve()});